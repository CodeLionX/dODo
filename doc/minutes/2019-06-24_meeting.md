# Seminar Meeting 2019-06-24

## Master actor refactoring

- needed? yes, but complicated!
- ideas:
  - remove state (`context.become`)-based logic with mutable state and a static receive combined of methods representing each task
  - move logic and some state to util classes

## How to sync reduced columns

- Move knowledge of reduced columns to `Dataholder`
  - We have to make sure they get updated and spread across the nodes.
- Let joining nodes ask for reduced columns first before starting work stealing protocol
  - :heavy_check_mark: Broadcast of the reduced columns over the `PubSubModule` and let late nodes send a `Send` message to one of the subscribed nodes.
    The receiving node then replies with the reduced columns (if not ready yet, the columns haven't been broadcasted and so the new node will receive the broadcast anyway). **Attention:** At-most-once delivery (joining nodes resend the request if no reduced columns were received)

## Downing Protocol

We change the message to send the workload (queue size) (`Workload`) to also include the pending candidates queue size and the node address (including the node ID (`longId`)).

1. After receiving the `WorkloadTimeout` and

   - all other work queues are empty (`sum == 0`)
   - other pending work queues are empty
   - our own work queue is empty
   - our own pending work queue is empty

   we ask the `clusterListener` for the current cluster size and check if we received the workload from all other masters.
   If yes, we can safely shutdown.

2. If not, we initiate a second downing step:
   1. Resend broadcast to get workload to all other masters
   2. Wait for all to answer and perform the above checks again.
      If they succeed, we can shutdown.
      If not, we steal work based on the work stealing protocol.
   3. Use timeout to inform user (via log) about the shutdown waiting state.
   4. In this state, we have to be aware of all cluster-shrinkages. The master itself can register for the cluster event `MemberRemoved` to get updates.
      We check the node addresses to be sure we update the received `Workload` messages correctly.

## Implementation of State-Sync Protocol

- depends on refactoring?
- postponed to tomorrow!
